#!/usr/bin/env node

var program = require('commander');
var pkg = require('../package.json');
var output = require('../lib/output');
var tape = require('tape');
var fs = require('fs');
var path = require('path');
var readline = require('readline');

var example = function () {
  var rl = readline.createInterface({
    input: fs.createReadStream(path.join(__dirname, '../test/js/example-tests.js'))
  });

  rl.on('line', function (line) {
    console.log('   ', line);
  });

  rl.on('close', function () {
    console.log('');
  });
};

program
  .version(pkg.version);

program
  .usage('<command> <options>')
  .command('openapi <openapi.json>')
  .option('-v, --validate', 'Validate OpenAPI file (is it a valid ) .')
  .option('-x, --xunit', 'Output xunit.')
  .description('OpenAPI utils.')
  .action(function (swaggerFile, options) {
    var opts = options;
    opts.tape = tape;
    opts.testFile = './swagger-tests.js';
    opts.swaggerFile = swaggerFile;
    output.action(opts).pipe(process.stdout);
  });

program
  .usage('<command> <options>')
  .command('json <schema.json> <test.json>')
  .option('-x, --xunit', 'Output xunit.')
  .description('JSON validation.')
  .action(function (schemaFile, jsonFile, options) {
    var opts = options;
    opts.tape = tape;
    opts.schemaFile = schemaFile;
    opts.jsonFile = jsonFile;
    output.action(opts).pipe(process.stdout);
  });

program
  .usage('<command> <options>')
  .command('js <tests.js>')
  .option('-x, --xunit', 'Output xunit.')
  .description('Run tape tests')
  .action(function (testFile, options) {
    console.log('js', testFile);
    var opts = options;
    opts.tape = tape;
    opts.testFile = testFile;
    output.action(opts).pipe(process.stdout);
  });


program.on('--help', function (){
  console.log('  Examples:');
  console.log('');
  console.log('    $ rotan openapi openapi.json');
  console.log('    $ rotan js index.js');
  console.log('');
  console.log('  Write your tape tests like this:');
  console.log('');
  example();
});


program.parse(process.argv);

if (!process.argv.slice(2).length) {
  program.outputHelp();
}
